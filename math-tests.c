#include <stdio.h>
#include <stdint.h>
#include <stdbool.h>
#include <math.h>

const uint8_t sin_table[] = {
0, //0.00 0.00 0
2, //0.01 0.35 1
3, //0.01 0.70 2
5, //0.02 1.05 3
6, //0.02 1.41 4
8, //0.03 1.76 5
9, //0.04 2.11 6
11, //0.04 2.46 7
13, //0.05 2.81 8
14, //0.06 3.16 9
16, //0.06 3.51 10
17, //0.07 3.87 11
19, //0.07 4.22 12
20, //0.08 4.57 13
22, //0.09 4.92 14
23, //0.09 5.27 15
25, //0.10 5.62 16
27, //0.10 5.98 17
28, //0.11 6.33 18
30, //0.12 6.68 19
31, //0.12 7.03 20
33, //0.13 7.38 21
34, //0.13 7.73 22
36, //0.14 8.08 23
38, //0.15 8.44 24
39, //0.15 8.79 25
41, //0.16 9.14 26
42, //0.17 9.49 27
44, //0.17 9.84 28
45, //0.18 10.19 29
47, //0.18 10.54 30
48, //0.19 10.90 31
50, //0.20 11.25 32
51, //0.20 11.60 33
53, //0.21 11.95 34
54, //0.21 12.30 35
56, //0.22 12.65 36
58, //0.23 13.01 37
59, //0.23 13.36 38
61, //0.24 13.71 39
62, //0.24 14.06 40
64, //0.25 14.41 41
65, //0.26 14.76 42
67, //0.26 15.11 43
68, //0.27 15.47 44
70, //0.27 15.82 45
71, //0.28 16.17 46
73, //0.29 16.52 47
74, //0.29 16.87 48
76, //0.30 17.22 49
77, //0.30 17.57 50
79, //0.31 17.93 51
80, //0.31 18.28 52
82, //0.32 18.63 53
83, //0.33 18.98 54
85, //0.33 19.33 55
86, //0.34 19.68 56
88, //0.34 20.04 57
89, //0.35 20.39 58
91, //0.36 20.74 59
92, //0.36 21.09 60
93, //0.37 21.44 61
95, //0.37 21.79 62
96, //0.38 22.14 63
98, //0.38 22.50 64
99, //0.39 22.85 65
101, //0.39 23.20 66
102, //0.40 23.55 67
104, //0.41 23.90 68
105, //0.41 24.25 69
106, //0.42 24.60 70
108, //0.42 24.96 71
109, //0.43 25.31 72
111, //0.43 25.66 73
112, //0.44 26.01 74
114, //0.45 26.36 75
115, //0.45 26.71 76
116, //0.46 27.07 77
118, //0.46 27.42 78
119, //0.47 27.77 79
120, //0.47 28.12 80
122, //0.48 28.47 81
123, //0.48 28.82 82
125, //0.49 29.17 83
126, //0.49 29.53 84
127, //0.50 29.88 85
129, //0.50 30.23 86
130, //0.51 30.58 87
131, //0.52 30.93 88
133, //0.52 31.28 89
134, //0.53 31.63 90
135, //0.53 31.99 91
137, //0.54 32.34 92
138, //0.54 32.69 93
139, //0.55 33.04 94
141, //0.55 33.39 95
142, //0.56 33.74 96
143, //0.56 34.09 97
145, //0.57 34.45 98
146, //0.57 34.80 99
147, //0.58 35.15 100
148, //0.58 35.50 101
150, //0.59 35.85 102
151, //0.59 36.20 103
152, //0.60 36.56 104
153, //0.60 36.91 105
155, //0.61 37.26 106
156, //0.61 37.61 107
157, //0.62 37.96 108
158, //0.62 38.31 109
160, //0.63 38.66 110
161, //0.63 39.02 111
162, //0.64 39.37 112
163, //0.64 39.72 113
165, //0.65 40.07 114
166, //0.65 40.42 115
167, //0.65 40.77 116
168, //0.66 41.12 117
169, //0.66 41.48 118
170, //0.67 41.83 119
172, //0.67 42.18 120
173, //0.68 42.53 121
174, //0.68 42.88 122
175, //0.69 43.23 123
176, //0.69 43.59 124
177, //0.70 43.94 125
178, //0.70 44.29 126
180, //0.70 44.64 127
181, //0.71 44.99 128
182, //0.71 45.34 129
183, //0.72 45.69 130
184, //0.72 46.05 131
185, //0.73 46.40 132
186, //0.73 46.75 133
187, //0.73 47.10 134
188, //0.74 47.45 135
189, //0.74 47.80 136
190, //0.75 48.15 137
191, //0.75 48.51 138
192, //0.75 48.86 139
193, //0.76 49.21 140
194, //0.76 49.56 141
195, //0.77 49.91 142
196, //0.77 50.26 143
197, //0.77 50.62 144
198, //0.78 50.97 145
199, //0.78 51.32 146
200, //0.79 51.67 147
201, //0.79 52.02 148
202, //0.79 52.37 149
203, //0.80 52.72 150
204, //0.80 53.08 151
205, //0.80 53.43 152
206, //0.81 53.78 153
207, //0.81 54.13 154
208, //0.82 54.48 155
209, //0.82 54.83 156
210, //0.82 55.18 157
211, //0.83 55.54 158
211, //0.83 55.89 159
212, //0.83 56.24 160
213, //0.84 56.59 161
214, //0.84 56.94 162
215, //0.84 57.29 163
216, //0.85 57.64 164
217, //0.85 58.00 165
217, //0.85 58.35 166
218, //0.86 58.70 167
219, //0.86 59.05 168
220, //0.86 59.40 169
221, //0.87 59.75 170
221, //0.87 60.11 171
222, //0.87 60.46 172
223, //0.87 60.81 173
224, //0.88 61.16 174
224, //0.88 61.51 175
225, //0.88 61.86 176
226, //0.89 62.21 177
227, //0.89 62.57 178
227, //0.89 62.92 179
228, //0.89 63.27 180
229, //0.90 63.62 181
229, //0.90 63.97 182
230, //0.90 64.32 183
231, //0.91 64.67 184
231, //0.91 65.03 185
232, //0.91 65.38 186
233, //0.91 65.73 187
233, //0.92 66.08 188
234, //0.92 66.43 189
235, //0.92 66.78 190
235, //0.92 67.14 191
236, //0.92 67.49 192
236, //0.93 67.84 193
237, //0.93 68.19 194
238, //0.93 68.54 195
238, //0.93 68.89 196
239, //0.94 69.24 197
239, //0.94 69.60 198
240, //0.94 69.95 199
240, //0.94 70.30 200
241, //0.94 70.65 201
241, //0.95 71.00 202
242, //0.95 71.35 203
242, //0.95 71.70 204
243, //0.95 72.06 205
243, //0.95 72.41 206
244, //0.96 72.76 207
244, //0.96 73.11 208
245, //0.96 73.46 209
245, //0.96 73.81 210
246, //0.96 74.17 211
246, //0.96 74.52 212
246, //0.97 74.87 213
247, //0.97 75.22 214
247, //0.97 75.57 215
248, //0.97 75.92 216
248, //0.97 76.27 217
248, //0.97 76.63 218
249, //0.98 76.98 219
249, //0.98 77.33 220
249, //0.98 77.68 221
250, //0.98 78.03 222
250, //0.98 78.38 223
250, //0.98 78.73 224
251, //0.98 79.09 225
251, //0.98 79.44 226
251, //0.98 79.79 227
251, //0.99 80.14 228
252, //0.99 80.49 229
252, //0.99 80.84 230
252, //0.99 81.20 231
252, //0.99 81.55 232
253, //0.99 81.90 233
253, //0.99 82.25 234
253, //0.99 82.60 235
253, //0.99 82.95 236
253, //0.99 83.30 237
254, //0.99 83.66 238
254, //0.99 84.01 239
254, //1.00 84.36 240
254, //1.00 84.71 241
254, //1.00 85.06 242
254, //1.00 85.41 243
254, //1.00 85.76 244
254, //1.00 86.12 245
255, //1.00 86.47 246
255, //1.00 86.82 247
255, //1.00 87.17 248
255, //1.00 87.52 249
255, //1.00 87.87 250
255, //1.00 88.22 251
255, //1.00 88.58 252
255, //1.00 88.93 253
255, //1.00 89.28 254
255, //1.00 89.63 255
255, //1.00 89.98 256
};

#define MIN(a,b) (((a)<(b))?(a):(b))
#define MAX(a,b) (((a)>(b))?(a):(b))
#define LSB(x) (uint8_t)((uint16_t)(x) & 0xFF)
#define MSB(x) (uint8_t)(((uint16_t)(x) >> 8) & 0xFF)
#define SEGA_ANGLE(deg)    ((int16_t)(((float)(deg))*2.845))
#define SEGA_ANGLE_F(deg)  (((float)(deg))*2.845)
#define SCALE 255  // i.e. 1<<8 fixed point scaling for sin table

uint8_t sinlut(uint16_t sega_angle, bool *negsign) {
    if ( sega_angle < SEGA_ANGLE(90) ) {
        *negsign = false;
        return sin_table[ sega_angle ];
    }
    if ( sega_angle < SEGA_ANGLE(180) ) {
        sega_angle -= SEGA_ANGLE(90);
        *negsign = false;
        return sin_table[ SEGA_ANGLE(90) - sega_angle ];
    }
    if ( sega_angle < SEGA_ANGLE(270) ) {
        sega_angle -= SEGA_ANGLE(180);
        *negsign = true;
        return sin_table[ sega_angle ];
    }
    sega_angle -= SEGA_ANGLE(270);
    *negsign = true;
    return sin_table[ SEGA_ANGLE(90) - sega_angle ];
}

uint8_t coslut(uint16_t sega_angle, bool *negsign) {
    sega_angle += SEGA_ANGLE(90);
    if (sega_angle>=SEGA_ANGLE(360)) {
        sega_angle -= SEGA_ANGLE(360);
    }
    return sinlut( sega_angle, negsign );
}

uint16_t xy_multiply(uint8_t x, uint8_t y) {
    return x * y;
}

static void vectorPosition( uint16_t sega_angle, uint16_t length, int16_t *x, int16_t *y ) {
  bool sin_neg, cos_neg;
  uint8_t sin_value = sinlut( sega_angle, &sin_neg );
  uint8_t cos_value = coslut( sega_angle, &cos_neg );
  *x = 0; *y = 0;
  do {
    uint8_t l = MIN(length,254);
    printf("(%d %d)",l, length);
    *x += xy_multiply( 1 + l, sin_value ) >> 8;
    *y += xy_multiply( 1 + l, cos_value ) >> 8;
    length -= l;
  } while (length);
  if (sin_neg) {
      *x = - *x;
  }
  if (cos_neg) {
      *y = - *y;
  }
}

const uint8_t atan_table[] = {
   0,0,0,0,0,0,0,0,
   255,128,75,52,40,32,27,23,
   255,180,128,96,75,62,52,45,
   255,203,160,128,105,88,75,66,
   255,216,180,151,128,110,96,84,
   255,223,194,168,146,128,113,101,
   255,229,203,180,160,142,128,115,
   255,232,210,190,171,155,140,128,
};


uint8_t _atan(uint8_t x, uint8_t y) {
   return atan_table[ (x<<3) + y ];
}


int main(void) {
    
    printf("const uint8_t sin_table[] = {\n");
    for (float sa=0; sa<SEGA_ANGLE_F(90); sa++) {
        // radians 0 is East and CCW
        // sega 0 is North and CW
        float a = sa/SEGA_ANGLE_F(1);
        float r = a*0.0175;
        float s = sin(r);
        float sfp = s*(float)SCALE;
        //printf("%d, //%0.2f %0.2f %0.0f\n", (int)roundf(sfp), s, a, sa );
        printf("%d,", (int)roundf(sfp));
    }
    printf("\n};\n");
    
    for (float sa=0; sa<SEGA_ANGLE_F(360); sa+=6) {
        float a = sa/SEGA_ANGLE_F(1);
        float r = a*0.0175;
        float length = 1024;
        float x = sin(r) * length;
        float y = cos(r) * length;
        bool sign;
        printf("%0.0f %0.0f  %d %d  %d %d  %0.0f %0.0f  ", a, sa, 
                sinlut(sa, &sign), (int)(sin(r)*128.0),
                coslut(sa, &sign), (int)(cos(r)*128.0),
                x, y
                );
        int16_t x1, y1;
        vectorPosition( sa, length, &x1, &y1 );
        printf("%d %d\n", x1, y1 );
    }

    printf("const uint8_t atan_table[] = {\n");
    for (int x=0; x<8; x++) {
       printf("   ");
       // would it make more sense to use a ratio of x/y as the index?
       // might need to x100 or /100 depending on reflection of x <y or y>x ?
       for (int y=0; y<8; y++) {
           float in = (float)x / (float)y;
           float a = atan( in );
           float d = a / 0.0175;
           float sa = SEGA_ANGLE_F(d);
           printf("%d, //%d,%d %0.2f %0.2f\n", (int)roundf(sa), x, y, in, d);
           if ( x + y == 0 ) {
              sa = 0;
           }
           //printf("%d,", (int)roundf(sa));
       }
       printf("\n");
    }
    printf("};\n");

    for (int x=0; x<8; x++) {
       for (int y=0; y<8; y++) {
           float a = atan( (float)x / (float)y );
           float d = a / 0.0175;
           float sa = SEGA_ANGLE_F(d);
           printf("%d,%d %0.0f %d\n",x,y,sa, _atan(x,y) );
        }
     }


    return 0;
}

